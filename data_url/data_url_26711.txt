Energy and potential are not consistent using GAPW with meta-GGA functionals. An OT CG SCF run for a water molecule using GAPW with TPSS does not converge. A debug run with diagonalization shows wrong analytical (atomic) forces as discussed here
I am somewhat familiar with GAPW, I'll have a look.
The following H2O input still does not converge with GAPW for the mGGA functional TPSS using OT CG indicating that the issue has not been resolved fully. OT DIIS converges with the basis set DZVP-ALL instead of 6-31Gxx, but there is then still a force mismatch detected.
@abussy Please, could you check again.
@mkrack Thanks for the feedback. This problem seems to only appear with OT. When I run your input with standard diagonalization it works fine. I double checked my math and implementation and couldn't find a mistake (for now at least). As of now, I am quite puzzled as to why OT fails.
A convergence failure of OT CG indicates an inconsistency of (KS) potential and energy, since the wavefunction gradient combined with just energy calculation in the LS step is employed in the SCF iteration cycle. Diagonalisation and OT DIIS are not sensible in that way and might converge without problem. Thus a failure of OT CG is a first indicator that something is fishy, i.e. either energy or potential are wrong. Switching to GPW while keeping TPSS as XCFUN or to PBE while keeping GAPW as method in the test input allows for convergence with OT CG. I think you fixed one bug in GAPW, but there might be other issues with GAPW for mGGAs. I observe also a dependence on the basis set. For instance the DZVP-ALL basis set behaves less problematic than the 6-31G** basis set.
Looking at the GPW code in grid_integrate.F:

and comparing to the GAPW forces in qs_ks_atom.F, it seems that the whole IF clause regarding tau functionals is completely ignored/forgotten. This is something that I oversaw as I was hunting for tau code to correct and this did not show up.
There is definitely more work to be done and I guess that I was "lucky" in my previous tests that the tau influence on forces was small. I do not think this will fix OT convergence issues though.
@abussy, I'm just about to migrate that code from grid_integrate.F to C (#1144). In the process I discovered a very compact notation. So, maybe it's actually easier to fix the problem in the new code?
@oschuett grid_integrate.F and the general treatment of meta-GGA functionals in GPW are fine. The problem lies in qs_ks_atom.F, so most likely the C migration will not affect this issue.
I did some more work and came up with this PR  #1169. @mkrack with the new code, your input for TPSS water runs fine, for both  DZVP-ALL and 6-31Gxx basis sets, using the CG minimizer for OT.
I also speculated that atomic forces were wrong due to some explicit treatment of tau functionals in GPW ( grid_integrate.F), which was absent from GAPW. Upon closer inspection, I realised that it is implicitly done in qs_ks_atom.F. Successful DEBUG runs for the forces seem to suggest that the atomic force treatment in metaGGA GAPW is actually correct.
@abussy Good job! The issue is resolved. I confirm that the all-electron GAPW mGGA (TPSS and M06-2X) DEBUG runs using OT CG converge now and the forces are correct.
