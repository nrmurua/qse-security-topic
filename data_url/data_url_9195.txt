It would be good to implement the hafnian algorithm for rank-deficient matrices sketched in Appendix C of A Faster Hafnian Formula for Complex Matrices and Its Benchmarking on a Supercomputer
