While developing a Grover's tutorial for the new Qiskit Runtime primitives, I found a bug where the grover circuit submitted to runtime provider with sampler program return TypeError: __init__() takes 2 positional arguments but 5 were given. After some investigation, I have narrowed down the issue to UCRZGate which is part of the Grover operator in the grover circuit.
qpy code based on this answer by @mtreinish on StackExchange.
Circuits containing UCRZGate should be able to be serialized by QPY.
No response
The problem is the UCRZGate is non-standard in it's construction. It looks like it sets the params attribute to the angle list (as does anything based on UCPauliRotGate. By default qpy deserialization tries to do deserialize a gate as cls(*params) to create an instance of the gate in the circuit. However that doesn't work because the ucrz params is the angle list. To fix this we'll probably need to do two things, first special case the deserialization for the UCPauliRotGate family of gates here:
https://github.com/Qiskit/qiskit-terra/blob/main/qiskit/qpy/binary_io/circuits.py#L240-L257
so that qpy knows that it needs to handle the creation of them separately as they're not built in the standard way. Secondly it might require updating this function if we need to include extra attributes in the serialization of the gate https://github.com/Qiskit/qiskit-terra/blob/main/qiskit/qpy/binary_io/circuits.py#L382 function to enable creating a new equivalent instance in deserialization (I'm thinking for a generic UCPauliRotGate we might need to embed the rotation axis as an extra parameter as that's not stored in the params list)
I see. That sounds like my next project :D Can I assign myself on this issue? I will take a closer look at QPY later. For the purpose of creating the Grover tutorial, I am going to use decomposed circuits below UCRZ level which I have tested working.
