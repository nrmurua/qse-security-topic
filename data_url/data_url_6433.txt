Highlighted in #531 - apparently CircuitOperation(use_repetition_ids=False) does not convert properly to qsim due to not finding the associated measurements.
I think the problem occurs also with use_repetition_ids=True and whether or not the circuit operation has repetitions. Here's a minimal example:
Yup, looks like we've been relying on findall_operations_with_gate_type, which doesn't bother searching inside of CircuitOperations. Modifying that method is probably the right way to resolve this, although because of how qsimcirq handles the output we won't be able to support repeat-until without additional changes.
One additional issue: findall_operations_with_gate_type returns a (moment index, op, gate) tuple. For a sub-operation of a CircuitOperation, moment index doesn't precisely locate the operation.
I think some specific logic for finding measurement operations would be generically useful. For example, in cirq-google we have a find_measurements function to find measurements in a circuit which does something similar to what we need here (that function also needs to be updated to handle CircuitOperation).
