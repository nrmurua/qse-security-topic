Done but untested (and likely has a few bugs).
Analyzer traces look good.
OK seems everything works.
