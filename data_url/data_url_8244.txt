Include the improvements made on #1208. These changes base from #1209 and #1212:
