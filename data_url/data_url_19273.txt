Hi, I just noticed that extracting the frequencies and samples from a result does not commute, i.e. once I run my circuit, if I extract first the frequencies and then the samples, they do not match, whereas if I extract first the samples and then the frequencies, everything agrees. Is this a bug, or am I missing something? Here is an example code:
Thanks for reporting this. I would also classify it as a bug, but just to explain why it happens:
If you then ask for samples, they will be sampled from scratch, not calculated from the cached frequencies, so there will be a disagreement.
The reason we are not sampling individual samples when you don't ask for them is performance. There was an application where we needed >1e8 shots and it was more efficient to sample the frequencies directly (see #332, #330) instead of going through samples.
That being said, we could fix this bug by forcing the samples to respect the frequencies if they have already been sampled first. At least that's the quickest solution I can think of.
