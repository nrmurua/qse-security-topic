The following Quil snippet triggers an error during compression in quilc 1.8.2-hotfix:
The ultimate source of the error appears to be in diagonalizer-in-e-basis, which attempts to group the eigenvectors emitted by magicl:eig into common eigenspaces. The eigenspaces in the above sequence are completely degenerate: everything ought to belong to the eigenspace of weight 1, but d-i-e-b sorts them into pairs of weight 1±eps, which causes some cascading failure further down the line (specifically: find-real-spanning-set goes off the rails).
I propose we first look into Gavin's randomized algorithm for performing this computation. If his approach only deals with instability in find-real-spanning-set, then that's no help here; but if it obviates us from having to sort the eigenvectors as well, then that could be a good approach. Failing that, I don't have an immediate idea for an approach to this.
We initially suspected that the large angle values appearing in the above snippet (e.g., -22.61946710582502) were part of the underlying cause, but Michał has since reported that he can trigger this bug with angles constrained to [-2pi, 2pi].
@ecpeterson with today's changes:
