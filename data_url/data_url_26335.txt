I was looking at a profile of 64-H2O-RPA which I ran with the PW GPU backend and observed that offloadMemcpyAsync calls were slower than expected. Tracing the caller path, I see that allocations for host buffers used in these calls (for instance, pw%cc) are done in pw_create using Fortran ALLOCATE calls. I may have missed a subsequent offloadHostRegister call, but it looks like these buffers are not allocated using hipHostMalloc (or the CUDA equivalent cudaMallocHost) or registered later. Due to this, we may be doing a synchronous copy instead. I believe there is performance to gain if we could allocate these buffers in pinned memory. Could you help check if I am right and help with a fix?
While the plane wave code does already pin a couple of buffers, it might very well be that some are still missing. Unfortunately, I'm not very familiar with that code - not sure anybody actually still is.
