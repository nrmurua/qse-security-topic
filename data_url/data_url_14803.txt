I am trying to learn some Quantum Machine Learning models with Qiskit and after a training of >2h my process is killed from the operating system, because the RAM usage got too high. The tracemalloc library hinted me to the class ParameterReferences inside qiskit/circuit/parametertable.py, which seems to accumulate memory space after every iteration:
Unfortunately every attempt to create a minimal working example failed on my side, because I don't find the exact circumstances why and where this happens. Nevertheless, I would like to provide a small example how I use the qiskit library and how my iterations look like
No accumulation of memory space
Can you think of any circumstances, in which an object of the class ParameterReferences might accumulate memory space? Can you give me some context about this class, such that it helps me to find the bug in my code? Any hint could be helpful, thank you in advance
A few things that may or may not help:
As a suggestion for you to look: maybe try and audit your code base and make sure that you're not keeping references to all temporary QuantumCircuit objects during your optimisation pass.  If you're storing references to them in a "history" list or anything like that, that could be the reason that the references aren't getting freed correctly.
@jakelishman Thank you very much for your answer. I also think, that the ParameterTable class is not the actual root cause of the problem. But unfortunately, I do not save my QuantumCircuit in any kind of history list. I only create a list of QuantumCircuit in the beginning, such that I don't need to generate the circuits in each forward pass. Like this:
I just tested that as well and it seems not to accumulate memory space in my minimal working example either. Anyway, I needed to change my trainings to TorchConnector from Qiskit Machine Learning, because the Adam Optimizer using Parameter Shift Rule for gradient calculation resulted in much better results. So my whole training procedure changed and I don't experience similar problems anymore. I guess I wont do any further debugging
