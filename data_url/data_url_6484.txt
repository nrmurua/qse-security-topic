Hi there,
I encountered a strange problem when using qsim. Below is the script that can reproduce the error. Basically, I first generate the set of all single-qubit Clifford gates, which is _single_qubit_clifford. Then, I define a circuit by adding gates layer by layer; one layer of single-qubit Clifford gate followed by a layer of CNOTs and so on. Besides, I also added errors after each layer. This will be perfectly fine to the qsim simulator.
But for some reason, I need to insert some addition gates in the middle of the circuit, which is cirq.X(qubits[0]) in the example. Then, it return an error message, saying ValueError: could not broadcast input array from shape (0,) into shape (4,). Below is the case that I found will be no problem:
I tried to look into this problem for several hours, but I couldn't figure out what is going on exactly, only to discover how to work around it by the 'merge' method. Any idea what's happening? Thanks!
The root error is the fuser: gate at time 4 is out of time order message this produces, which is due to an error in the circuit translation code. In short, noiseless ops can decompose into multiple time steps, but noisy ops cannot. qsim was adding a copy of the noisy gates for each time step produced by the noiseless gates.
A fix is up in #554. If you're using qsim by cloning the repo, you can simply patch the change in (it's only 3 lines); if you got qsim via pip install qsimcirq you can either try cloning and building locally or wait for a patch release - there should be at least one coming out in the next week.
