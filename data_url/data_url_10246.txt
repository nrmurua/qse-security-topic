Simplify and optimize, adjust for #166.
